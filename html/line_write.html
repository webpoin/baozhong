<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
	<meta content="yes" name="apple-mobile-web-app-capable"/> 
	<meta content="yes" name="apple-touch-fullscreen"/> 
	<meta name="data-spm" content="a215s"/> 
	<meta content="telephone=no,email=no" name="format-detection"/>
	<meta content="fullscreen=yes,preventMove=no" name="ML-Config"/>
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires"content="0">
	<link rel="stylesheet" type="text/css" href="../css/style.css">
	<style type="text/css">
		#container{position: absolute;width: 100%;left: 0; top: 64px;bottom: 60px;}
		#container .scroll{position: absolute;left: 0;top: 0;width: 100%;min-height: 100%;padding-bottom: 10px;}
		.line_ctrl{position: fixed;bottom: 0;width: 100%;left: 0;}
		.mui-android #container {overflow: auto;}

	</style>
	<title>Document</title>
</head>
<body>


	<div class="loading loading2"><img src="../images/loading.gif" alt=""></div>
	

	<header>
		<cite>
			<h2>填写游客信息</h2>
		    <small class="toback"><i class="icon icon-fanhui"></i></small>
		</cite>
	</header>

	<div class="pullRefresh" id="container">
		<div class="scroll">


			<section class="write_info" id="write_info"  >
				<div class="collect_img"><img data-src="{{lineImageUrl}}" alt=""></div>
				<h3>{{name}}</h3>
				<p>出发日期：{{useDate}}</p>
				<p>出发城市：{{startingAreaName}}</p>
				<p>出游人数：{{number}}人</p>
				<h6>
					<label>
						<input type="checkbox" name="" checked="checked" id="js-agree">
						<span>我已阅读并接受</span>
					</label>
					<a href="article.html?title=出游合同&type=getLineContract&businessUnitId={{businessUnitId}}&lineCategoryId={{lineCategoryId}}">《预定须知，合同，保险等条款》</a>
				</h6>
			</section>

			<form action="#" class="contacts_add write_self" id="write_self" style="border-top:1px solid #c8c7cc;">
				<h2 class="order_title">
					<i class="icon icon-xingzhuang258"></i>
					<strong>预定人信息</strong>
				</h2>
				<ul>
					<li>
						<span><i class="icon icon-xingzhuang185"></i>姓名</span>
						<label><input type="text" placeholder="必填" value="{{name}}" id="js-name"></label>
					</li>
					<li>
						<span><i class="icon icon-xingzhuang226"></i>手机号码</span>
						<label><input type="text" placeholder="必填" value="{{mobile}}" id="js-mobile"></label>
					</li>
					<li>
						<span><i class="icon icon-xingzhuang226"></i>电子邮箱</span>
						<label><input type="text" placeholder="非必填" value="" id="js-email"></label>
					</li>
				</ul>
			</form>


			<section class="write_other" id="write_other" >
				<h2 class="order_title">
					<i class="icon icon-xingzhuang1"></i>
					<strong>出游游客</strong>
					<b>[{{count_select}}/{{count_booking}}]</b>
					<em class="{{enough}}">未满8位</em>
					<span><a href="user_contacts_select.html?id={{id}}" viewId="user_contacts_select">选择游客</a></span>
				</h2>
				<h3>请点击右上角添加出行游客</h3>
				<ul>
					 <li subdata="{{select}}">
						<strong>{{name}}(成人)</strong>
						<p>{{remark}}</p>
						<label id="{{id}}"><input type="checkbox" name="" class="additioal_{{id}}" ><b>附加服务</b></label>
					</li>
				</ul>
			</section>

			<section class="order_insurance" id="insurance">
				<h2 class="order_title">
					<i class="icon icon-baoxian"></i>
					<strong>保险信息</strong>
				</h2>
				<ul>
					<li subdata="{{data}}" sellPriceListId="{{sellPriceListId}}" class="order_insurance_{{ifForceInsurance}}">
						<h3>
							<strong>{{sellPriceListName}}</strong>
							<small subdata="{{insurancePriceList}}">
								年龄：{{minAge}} - {{maxAge}} 岁<em>￥{{price}}</em>元/人<br>
							</small>
						</h3>
						<cite>
							<button class="minus">-</button>
							<span>0</span>
							<button class="plus">+</button>
						</cite>
					</li>
				</ul>
				<h6 class="{{havemore}}"></h6>
			</section>

			<section class="write_note">
				<h2 class="order_title">
					<i class="icon icon-teshuyaoqiu"></i>
					<strong>特殊要求</strong>
				</h2>
				<label><textarea id="remark" placeholder="如您有特殊要求，请在此告知我们"></textarea></label>
			</section>


		</div>
	</div>



	<section class="statistics" id="statistics">

		<div class="scroll">
			<dl>
				<dt><i class="icon icon-xingzhuang261"></i>费用明细</dt>
				<dd subdata="{{booking}}">
					<h3>
						<strong>{{name}} ({{productFormatName}})</strong>
						<span><em>￥{{price}}</em></span>
					</h3>
					
					<h4 subdata="{{additional}}">
						<b>+ {{name}}</b>
						<span><em>￥{{price}}</em></span>
					</h4>
				</dd>
			</dl>

			<dl>
				<dt><i class="icon icon-baoxian"></i>保险费用</dt>
				<dd subdata="{{insurance}}">
					<strong>{{sellPriceListName}}</strong>
					<p subdata="{{insurancePriceList}}">年龄{{minAge}}-{{maxAge}}，价格<em>￥{{price}}</em></p>
					<span>x <em>{{count}}</em></span>
				</dd>
			</dl>

			<h6>
				<strong>总计:</strong>
				<span>￥<em>{{total}}</em></span>
			</h6>
		</div>
		<a class="statistics_close"><i class="icon icon-xingzhuang268"></i></a>

	</section>


	<section class="line_ctrl">
		<cite>
			<span class="line_ctrl_total">总价:<em>￥--.--</em> <a>详细</a></span>
			<span class="line_ctrl_next disabled"><a><i class="icon icon-xingzhuang261"></i>提交订单</a></span>
		</cite>
	</section>
	
	<script src="../js/service.js"></script>
	<script src="../js/iscroll-lite.js"></script>
	<script src="../js/mui.min.js"></script>
	<script type="text/javascript">

		!function(u){
			// 如果是android，重写滚动
			if(u.indexOf('Android') > -1 || u.indexOf('Adr') > -1){
				IScroll = function (){this.refresh = function(){}}
			}
		}(navigator.userAgent)



		// 用户常量
		var format = {
			"1" : {name : "成人",discript: '法定年龄18到65周岁，具体独立法律责任的自然人'},
			"2" : {name : "老人(65-75)",discript: '法定年龄65到75周岁'},
			"3" : {name : "幼儿(占床)",discript: '法定年龄1到6周岁，使用独立床位'},
			"4" : {name : "小童(不占床)",discript: '法定年龄6到18周岁，不含独立床位'},
			"5" : {name : "婴儿",discript: '法定年龄1周岁以下，使用独立床位'},
			"6" : {name : "老人(75+)",discript: '超过75周岁的老年人，建议出游两人以上出行'},
		}

		var scroll = new IScroll('#container',{mouseWheel: false,scrollbars: false}); // 滚动
		var thenext = document.querySelector('.line_ctrl_next'); // 下一步
		var total = document.querySelector('.line_ctrl_total em'); // 总计标签
		var line_info = JSON.parse(localStorage.getItem('line_info')|| '{}'); //预订信息
		var line_booking = JSON.parse(localStorage.getItem('line_booking')|| '{}'); //预订信息
		var line_select = JSON.parse(localStorage.getItem('line_select') || '[]'); // 选定的游客信息
		var line_insurance = {}; // 保险信息
		var line_statistics = {}; // 详情信息
		var line_write = {}; // 订单信息对象，提交信息时使用

		// 计算总价
		var count = function(){

			var obj = {
				price_select : 0,		// 人员预定
				price_additional : 0,	// 附加服务费用
				price_insurance : 0,	// 保险费用
				price_total : 0,		// 费用总计
				insurance : [],
			}


			line_write.paperContract =  1 ;
			line_write.insuranceBuyList = [];
			line_write.touristList = [];
			line_statistics.booking = [];
			line_statistics.insurance = [];





			// 保险信息
			Array.prototype.slice.call(document.querySelectorAll('#insurance li')).map(function(i){
				var id = i.getAttribute('sellPriceListId');
				var insurance = line_insurance[id];
				var count = parseFloat(i.querySelector('cite span').innerHTML);

				if(!insurance){return;}
				insurance.count = count;
				insurance && insurance.insurancePriceList.map(function(i){
					i.count = count;
					obj.insurance.push(i);
				});

				line_write.insuranceBuyList.push({sellPriceListId:id,count:count,ifForceInsurance:insurance.ifForceInsurance});
				count >0 && line_statistics.insurance.push(insurance);

			});


			// 如果没有先游客，费用则为预约时的费用
			if(line_select.length == 0){
				obj.price_select = line_booking.total;
				line_booking.price.map(function(i){
					if(i.count<=0){return;}
					i.name = '预订'+ i.count + '人';
					line_statistics.booking.push(i);
				});
			}else{
				line_select.map(function(i){
					obj.price_select += parseFloat(i.price);

					i.additional = [];

					// 附加服务费用
					if(i.serviceAdditional){
						// 签证
						if(i.serviceAdditional.hasVisa == 1){
							obj.price_additional += i.serviceAdditional.visaPrice;
							i.additional.push({price:i.serviceAdditional.visaPrice,name:'已有鉴证'})
						}
						// 单人房差
						if(i.serviceAdditional.needSingleRoom == 1){
							obj.price_additional += i.serviceAdditional.singleRoomPrice;
							i.additional.push({price:i.serviceAdditional.singleRoomPrice,name:'单人房差'})

						}
					}

					// 保险费用
					obj.insurance.map(function(m){
						//  按年龄算
						if(i.old >= m.minAge && i.old <= m.maxAge){
							obj.price_insurance += parseFloat(m.price)*m.count;
						}
						
					});

					// 提交的信息
					line_write.touristList.push({
						id: i.id,
						touristTypeId : i.productFormatId,
						remark : i.remark,
						serviceAdditional : i.serviceAdditional
					});

					// 详情展示
					line_statistics.booking.push(i);
				});
			}




			// 全部费用，去浮点小数bug，不能小于0
			obj.price_total = obj.price_select + obj.price_additional + obj.price_insurance;
			obj.price_total = parseInt(obj.price_total*100)/100;
			obj.price_total = obj.price_total <0 ? 0 : obj.price_total;
			total.innerHTML = '￥'+ obj.price_total;


			// 是否可以支付
			// 接受协议
			var agree = document.getElementById('js-agree');
			// 预定人信息必填
			var name = document.getElementById('js-name').value;
			// 联系电话
			var mobile = document.getElementById('js-mobile').value;
			// 联系邮箱
			var email = document.getElementById('js-email').value;


			line_write.orderLinkman  = {"name":name,"mobile":mobile,"email":email}
			line_write.totalPrice = obj.price_total;
			line_write.remark =  document.getElementById('remark').value;
			line_statistics.total = obj.price_total;

			if(line_select.length >0 && agree.checked && name && mobile && /^1[3|4|5|7|8]\d{9}$/.test(mobile)){
				thenext.classList.remove('disabled');
			}else{
				thenext.classList.add('disabled');
			}


		}

		// 游客改变
		var selectChange = function(){
			line_select = JSON.parse(localStorage.getItem('line_select') || '[]');
			var data = {select:line_select};
			data.count_booking = line_booking.number;
			data.count_select = line_select.length;
			window.tplExchange(document.getElementById('write_other'),data);

			scroll.refresh();
		}


		// 线路信息
		!function(){
			
			// 把线路内容写入
			var line_info = JSON.parse(localStorage.getItem('line_info')|| '{}');
			var line_user = JSON.parse(localStorage.getItem('line_user')|| '{}');


			line_write.sellPriceListId = line_booking.sellPriceListId;
			line_info.useDate = line_booking.useDate;
			line_info.number = line_booking.number;

			window.tplExchange(document.getElementById('write_info'),line_info);
			window.tplExchange(document.getElementById('write_self'),line_user);

			scroll.refresh();


		}();


		// 保险信息
		service({
			"type" : "getInsurance",
			"lineCategoryId": line_info.lineCategoryId || 3,
			"sellPriceListId" : line_booking.sellPriceListId,
			"days": line_info.days || 3,
			"start":0,
			"limit":10
		},function(json){

			// 保存保险信息
			json.data.map(function(i){line_insurance[i.sellPriceListId] = i;});
			json.havemore = json.data.length >3 ? 'show' : '';

			window.tplExchange(document.getElementById('insurance'),json,!json.ret);

			// 触发选择一个保险
			var first = document.querySelector('.order_insurance_true .plus') || document.querySelector('.order_insurance .plus');


			first && mui.trigger(first,'tap');

			scroll.refresh();
			count();
			document.querySelector('.loading').classList.add('end');
		});

		

		// 打开附加服务
		mui('body').on('tap','.write_other label',function(){
			var home = plus.webview.getLaunchWebview();
			mui.fire(home,'openFull',{href:'header.html?title=附加服务&url=additional&id='+this.getAttribute('id')});
			return false;
		});

		// 减少人数
		mui('.order_insurance').on('tap','button.minus',function(){
			var parent = this.parentNode;
			var elem = parent.querySelector('span');
			var val = parseInt(elem.innerHTML);

			val = val <1 ? 0 : val -1 ;
			elem.innerHTML = val;

			// 如果为0，则判断
			if(val == 0){
				var number = 0;
				Array.prototype.slice.call(document.querySelectorAll('.order_insurance cite span')).map(function(i){
					number += parseInt(i.innerHTML);
				});
				if(number == 0){
					plus.ui.confirm("游客自愿放弃购买保险", function(i) {
						i.index == 1 && (elem.innerHTML = val + 1);
						count();
					}, "保险信息", ["确认", "取消"]);
				}else{
					count();
				}
			}else{
				count();
			}

			return false;
		});


		// 增加人数
		mui('.order_insurance').on('tap','button.plus',function(){

			var parent = this.parentNode;
			var elem = parent.querySelector('span');
			var val = parseInt(elem.innerHTML);
			elem.innerHTML = val +1;
			
			count();
			return false;
		});

		// 打开详情
		mui('.line_ctrl_total').on('tap','a',function(){
			window.tplExchange(document.getElementById('statistics'),line_statistics);
			document.querySelector('.statistics').style.display = 'block';;
			return false;
		});

		// 关闭详情
		mui('body').on('tap','a.statistics_close',function(){
			document.querySelector('.statistics').style.display = 'none';;
			return false;
		});


		// 展开收起保险信息
		mui('body').on('tap','.order_insurance h6',function(){
			
			var classList = this.parentNode.classList;
			if(classList.contains('active')){
				classList.remove('active');
			}else{
				classList.add('active');
			}

			scroll.refresh();
			return false;
		});


		// 下一步
		mui('body').on('tap','.line_ctrl_next a',function(){
			if(this.parentNode.classList.contains('disabled')){



				// 是否可以支付
				// 接受协议
				var agree = document.getElementById('js-agree');
				// 预定人信息必填
				var name = document.getElementById('js-name').value;
				// 联系电话
				var mobile = document.getElementById('js-mobile').value;
				// 联系邮箱
				var email = document.getElementById('js-email').value;

				var line_select = JSON.parse(localStorage.getItem('line_select') || '[]'); // 选定的游客信息


				if(line_select.length ==0){return plus.ui.toast('未选择游客') && false;}
				if(!agree.checked){return plus.ui.toast('未同意预订合同') && false;}
				if(!name){return plus.ui.toast('请输入预订人姓名') && false;}
				if(!mobile){return plus.ui.toast('请输入预订人联系号码') && false;}
				if(!/^1[3|4|5|7|8]\d{9}$/.test(mobile)){return plus.ui.toast('请输入正确的手机号码') && false;}
				if(email && !/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(email)){return plus.ui.toast('请输入正确的邮箱') && false;}
				return false;

			}
			line_write.type = 'addOrder';

			// 提交订单
			service(line_write,function(json){

				if(json.ret){

					var id = json.data.orderSaleId

					// 打开支付页面
					mui.fire(plus.webview.getLaunchWebview(),'openFull',{href: 'line_payway.html?id='+id});

					// // 关闭line页
					plus.webview.close('line','none');
					// // 关闭line_booking页面
					plus.webview.close('line_booking','none');
					// // 当前页更新为详情页
					plus.webview.currentWebview().loadURL('user_order_detail.html?orderSaleId='+id);

				}else{
					plus.ui.toast(json.msg);
				}
			});

			return false;
		});

	
		// 数据改变时
		mui(document).on('change','input',count);


		// 游客改变时
		window.addEventListener('selectChange',function(){
			selectChange();
			count();
		});


		// 修改附加服务
		window.addEventListener('additionalChange',function(event){


			var detail = event.detail;
			var elem = document.querySelector('.additioal_'+ detail.uid);

			if(detail.enable){
				elem.checked = true;
			}else{
				elem.checked = false;
			}


			line_select = JSON.parse(localStorage.getItem('line_select') || '[]');
			count();
		});

		// 初始化，更新游客信息
		selectChange();





	</script>

</body>
</html>